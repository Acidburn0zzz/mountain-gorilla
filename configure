#!/bin/bash
# vi: tabstop=4 expandtab shiftwidth=4
#
# Configure the mountain gorilla (aka SDC) build.
#


if [ "$TRACE" != "" ]; then
    export PS4='${BASH_SOURCE}:${LINENO}: '
    set -o xtrace
fi
set -o errexit
set -o pipefail



#---- config, globals

BRANCH="master"
BUILD_PLATFORM='true'

ZONES="mcp_api_admin booter mcp_api_gateway public-web-client cloud-api billing_api"
PLAT_COMPONENTS="illumos-joyent ur-agent kvm kvm-cmd-14 operator-toolkit sdc-platform"

ROOT=$(pwd)
JSON=$ROOT/tools/json

FORCE_RECONFIG='false'




#---- internal support functions

function fatal {
    echo "$(basename $0): error: $1"
    exit 1
}

function errexit {
    [[ $1 -ne 0 ]] || exit 0
    fatal "error exit status $1 at line $2"
}

function config_clean() {
    repo=$1
    # TODO: parse a repo:target mapping and clean targets better
    targ=$(cat repos.json | json $repo | json target)
    parent=$(cat repos.json | json $repo | json parents | json 0)
    gmake clean_$targ
    if [[ -n $parent ]]; then
          config_clean $parent
    fi
}

# Preload bits/ with the latest built and uploaded bits for
# the given target and branch.
# Usage:
#   preload_bits TARGET BRANCH
#
function preload_bits() {
    local target=$1
    local branch=$2

    echo "# preload bits/$target from stuff.joyent.us/builds/$target/$branch-latest/$target"
    local ssh="ssh -q -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null"
    mkdir -p bits/$target
    rsync -e "$ssh" -av \
        stuff@stuff.joyent.us:builds/$target/$branch-latest/$target/ \
        bits/$target/
}

# Get the requested repo.
# Usage:
#   get_repo2 REPO-URL BRANCH SUBMODULE-RECURSIVE
#
# If "SUBMODULE-RECURSIVE" is "true", then "--recursive" is used on
# on the "git submodule update ..." call.
#
function get_repo2() {
    local repo_url=$1
    local branch=$2
    local submodule_recursive=$3

    local repo_name=${repo_url##*/}    # strip to last '/'
    repo_name=${repo_name##*:}    # strip to last ':'
    repo_name=${repo_name%*.git}    # strip '.git' at tail

    echo "# get '$repo_url' to 'build/$repo_name'"
    local out
    if [[ ! -d build/$repo_name ]]; then
        mkdir -p build/$repo_name
        git clone -b $branch $repo_url build/$repo_name
    else
        out=$(cd build/$repo_name ; git checkout $branch ; git pull)
    fi
    if [[ "$submodule_recursive" == "true" ]]; then
        (cd build/$repo_name; git submodule update --init --recursive)
    else
        (cd build/$repo_name; git submodule update --init)
    fi
}


function get_repo() {
    local_branch=$1
    SRC=$2
    DEST=$3
    # Should be 'true' to request usage of '--recursive' on 'git submodule update ...' call.
    SUBMODULE_RECURSIVE=$4

    echo "# build/$DEST"
    if [[ ! -d build/$DEST ]]; then
        (mkdir -p build; git clone -b $local_branch git@git.joyent.com:${SRC}.git build/${DEST})
    else
        out=$(cd build/$DEST ; git checkout $local_branch ; git pull)
    fi
    if [[ "$SUBMODULE_RECURSIVE" == "true" ]]; then
        (cd build/$DEST; git submodule update --init --recursive)
    else
        (cd build/$DEST; git submodule update --init)
    fi

    #XXX
    #if [[ $out != "Already up-to-date." || $FORCE_RECONFIG == 'true' ]]; then
    #    config_clean $SRC
    #fi 
}

function get_github_repo() {
    SRC=$1
    DEST=$2
    GITHUBUSER=$3

    echo "# build/$DEST"
    if [[ ! -d build/$DEST ]]; then
        (mkdir -p build; git clone git://github.com/${GITHUBUSER}/${SRC}.git build/${DEST})
    else
        out=$(cd build/$DEST ; git pull)
    fi
    (cd build/$DEST; git submodule update --init --recursive )

    #XXX
    #if [[ $out != "Already up-to-date." ]]; then
    #    config_clean $SRC
    #fi 
}

function get_illumoslive() {
    local branch=$1
    if [[ `uname -s` == "SunOS" && $BUILD_PLATFORM == 'true' ]]; then
        get_repo2 git@git.joyent.com:illumos-live.git $branch true
        get_github_repo illumos-extra illumos-extra joyent
        for bit in $PLAT_COMPONENTS; do
            get_repo $branch $bit $bit true
        done
        PLATFORM_BRANCH=$BRANCH
        PLATFORM_SHA=$(cd build/illumos-live ; git log --pretty=format:'%h' -1 )
        sed -e "s/BRANCH/$BRANCH/" -e "s:GITCLONESOURCE:$ROOT/build/:" <illumos-configure.tmpl> build/illumos-live/configure.mg
        sed -e "s/BRANCH/$BRANCH/" <illumos-configure-branches.tmpl> build/illumos-live/configure-branches
    else
        BUILD_PLATFORM='false'
        platforms=$(ls bits/platform-*.tgz || /usr/bin/true)
        PLATFORM_TIMESTAMP=$(echo $platforms | sort | tail -n1 | \
            sed -e "s/platform.*-\([0-9TZ]*\)\.tgz/\1/" | \
            xargs -I timestamp basename timestamp)
        if [[ -z $PLATFORM_TIMESTAMP ]]; then
            echo "Error: not building platform file, and no platform file found. Exiting"
            exit 1
        fi
    fi
}

function get_zone_repo() {
    zone=$1
    branch=$2

    get_repo $branch $zone $zone true

    if [[ $zone == "cloud-api" ]]; then
        (cd build/cloud-api &&\
            mkdir -p ssl  && \
            mkdir -p node_modules)
        get_repo $1 node-sdc-clients cloud-api/node_modules/sdc-clients true
    fi
}

function get_zones() {
    # There's got to be a better way to enumerate this stuff
    for zone in $ZONES; do
        get_repo $1 $zone $zone true
    done

    # cloudapi is special, it uses 3 repos
    (cd build/cloud-api &&\
        mkdir -p ssl  && \
        mkdir -p node_modules)
    get_repo $1 node-sdc-clients cloud-api/node_modules/sdc-clients true

    cat <<EOF > build/usb-headnode/build.spec.local
  {
    "agents-shar": "$BRANCH"
  , "adminui-checkout": "origin/$BRANCH"
  , "ca-tarball": "^ca-pkg-$BRANCH-.*.tar.bz2$"
  , "amon-tarball": "^amon-master-$BRANCH-.*.tar.bz2$"
  , "dhcpd-checkout": "origin/$BRANCH"
  , "mapi-checkout": "origin/$BRANCH"
  , "portal-checkout": "origin/$BRANCH"
  , "cloudapi-checkout": "origin/$BRANCH"
  , "billapi-checkout": "origin/$BRANCH"
  , "rabbitmq-checkout": "origin/$BRANCH"
  , "ufds-checkout": "origin/$BRANCH"
  , "sdc-webinfo-checkout": "origin/$BRANCH"
}
EOF
}

function gen_config() {
    mkdir -p bits
    cat <<EOF >bits/config.mk
TIMESTAMP=$(TZ=UTC date "+%Y%m%dT%H%M%SZ")
BRANCH=$BRANCH

SMARTLOGIN_BRANCH=$BRANCH
SMARTLOGIN_SHA=$((cd build/smart-login 1>&2 2> /dev/null && git log --pretty=format:'%h' -1 ) || echo "")

AMON_BRANCH=$BRANCH
AMON_SHA=$((cd build/amon 1>&2 2> /dev/null && git log --pretty=format:'%h' -1 ) || echo "")

AGENTS_BRANCH=$BRANCH
AGENTS_SHA=$((cd build/agents 1>&2 2> /dev/null && git log --pretty=format:'%h' -1 ) || echo "")

CA_BRANCH=$BRANCH
CA_SHA=$((cd build/cloud-analytics 1>&2 2> /dev/null && git log --pretty=format:'%h' -1 ) || echo "")

UFDS_BRANCH=$BRANCH
UFDS_SHA=$((cd build/ufds 1>&2 2> /dev/null && git log --pretty=format:'%h' -1 ) || echo "")

AGENTSSHAR_BRANCH=$BRANCH
AGENTSSHAR_SHA=$((cd build/agents-installer 1>&2 2> /dev/null && git log --pretty=format:'%h' -1 ) || echo "")

USBHEADNODE_BRANCH=$BRANCH
USBHEADNODE_SHA=$((cd build/usb-headnode 1>&2 2> /dev/null && git log --pretty=format:'%h' -1 ) || echo "")

BUILD_PLATFORM=$BUILD_PLATFORM
EOF

    if [[ `uname -s` == "SunOS" && $BUILD_PLATFORM == 'true' ]]; then
        cat <<EOF >>bits/config.mk
PLATFORM_BRANCH=$PLATFORM_BRANCH
PLATFORM_SHA=$PLATFORM_SHA

EOF

        for zone in $ZONES; do
            capzone=$(echo $zone | tr [:lower:] [:upper:] | tr - _)
            cat <<EOF >>bits/config.mk
${capzone}_BRANCH=$BRANCH
${capzone}_SHA=$((cd build/$zone  1>&2 2> /dev/null && git log --pretty=format:'%h' -1 ) || echo "")
EOF

        done
    else
        cat <<EOF >>bits/config.mk
PLATFORM_TIMESTAMP=$PLATFORM_TIMESTAMP
EOF
    fi

    echo "'bits/config.mk' created."
}


function print_help() {
    echo "Configure this SDC build. This involves cloning/pulling the "
    echo "component source repositories."
    echo ""
    echo "Usage:"
    echo "  ./configure [ -b BRANCH ] [ -n ] [ -r REPO [-f] ] [ -t TARGET ]"
    echo ""
    echo "Options:"
    echo "  -h           Print this help and exit."
    echo "  -b BRANCH    Branch to checkout. Defaults to 'master'."
    echo "               Note that this is for *all* core repositories."
    echo "  -n           Do not build platform (only applicable on SmartOS)"
    echo "  -r REPO      Reconfigure build. Remove build artifacts, checkout to SHA in bits/config.mk or HEAD"
    echo "  -f           Force reconfig (clean and rebuild)"
    echo "  -t TARGET    Prepare to build only this target."
    exit 0
}



#---- mainline

trap 'errexit $? $LINENO' EXIT

# Can be a target name to tell 'configure' to (a) limit prep to just that
# target and (b) pre-load "bits/" with pre-built dependent target bits.
# If empty it means that we are configuring for a full build.
TARGET=

while getopts ":b:hunr:ft:" opt; do
    case $opt in
        b) BRANCH=$OPTARG;;
        h) print_help ;;
        n) BUILD_PLATFORM='false' ;;
        r) RECONFIG='true' ; RECONF_REPO=${OPTARG} ;;
        f) FORCE_RECONFIG='true' ;;
        t) TARGET=${OPTARG} ;;
        ?) fatal "unknown option: $opt" ;;
    esac
    shift $((OPTIND-1))
done

if [[ $RECONFIG == 'true' && -z $RECONF_REPO ]]; then
    print_help
    exit 1
fi


# The configure process wants to run "clean_*" targets in the Makefile.
# The Makefile needs a bits/config.mk to exist. An empty one will suffice for
# the clean targets.
mkdir -p bits
touch bits/config.mk

if [[ "$RECONFIG" == 'true' ]]; then
    #XXX TODO: reconfigure support:
    # - if a target is given ("./configure -r ca"), then just "clean_ca"
    #   - TODO: consider also blowing away all the associated build/$repo dirs for clean pull
    XXX
else
    make distclean
fi

if [[ ! -z "$TARGET" ]]; then
    for info in `cat targets.json | $JSON $TARGET.repos | $JSON -a -d, url submodule-recursive`; do
        repo_url=${info%,*}
        submodule_recursive=${info#*,}
        get_repo2 $repo_url $BRANCH $submodule_recursive
    done

    for targ in `cat targets.json | $JSON $TARGET.deps | $JSON -a`; do
        preload_bits $targ $BRANCH
    done
else
    # TODO: not sure about allow no arg to '-r'. Doesn't that screw up './configure -r -n'?
    if [[ -n $RECONF_REPO ]]; then
        if [[ $(echo $ZONES | grep $RECONF_REPO) ]]; then
            get_zone_repo $RECONF_REPO $BRANCH
        else
            targ=$(cat repos.json | json $RECONF_REPO | json target)
            if [[ -n $targ ]]; then
                RECONF_REPO=$targ
            fi
            get_$RECONF_REPO $BRANCH
        fi
    else
        #XXX: TODO: remove this touch requirement by switching to get_repo2
        mkdir -p bits
        touch bits/config.mk

        get_repo2 git@git.joyent.com:smart-login.git $BRANCH true
        get_repo2 git@git.joyent.com:amon.git $BRANCH true
        get_repo2 git@git.joyent.com:cloud-analytics.git $BRANCH false
        get_repo2 git@git.joyent.com:ufds.git $BRANCH true
        get_repo2 git@git.joyent.com:agents.git $BRANCH true
        get_repo2 git@git.joyent.com:agents-installer.git $BRANCH true
        get_repo2 git@git.joyent.com:usb-headnode.git $BRANCH true
        get_illumoslive $BRANCH
        get_zones $BRANCH
    fi
fi

gen_config
